# OpenGeoLab 代码架构文档

本文档详细描述 OpenGeoLab 项目的代码结构，帮助开发者快速理解和阅读代码。

---

## 目录结构概览

```
OpenGeoLab/
├── include/                # 头文件
│   ├── core/              # 核心工具类
│   ├── geometry/          # 几何数据结构
│   ├── io/                # 文件读写接口
│   ├── render/            # 渲染模块
│   └── ui/                # UI 相关类
├── src/                   # 源文件
│   ├── app/               # 应用入口
│   ├── core/              # 核心实现
│   ├── io/                # IO 实现
│   ├── render/            # 渲染实现
│   └── ui/                # UI 实现
├── resources/             # 资源文件
│   ├── icons/             # SVG 图标
│   └── qml/               # QML 界面文件
└── test/                  # 单元测试
```

---

## 一、渲染模块

渲染模块是项目的核心，负责 3D 图形的显示。

### 1.1 OpenGLRenderer (`render/opengl_renderer.hpp/cpp`)

**职责**：OpenGL 渲染器，负责将几何数据渲染到屏幕。

**关键成员变量**：
```cpp
// 相机和光照系统
std::unique_ptr<Camera> m_camera;          // 相机（负责视角变换）
LightingEnvironment m_lighting;             // 光照环境
Material m_material;                        // 材质属性

// OpenGL 资源
QOpenGLShaderProgram* m_program;           // 着色器程序
QOpenGLBuffer m_vbo;                       // 顶点缓冲
QOpenGLBuffer m_ebo;                       // 索引缓冲

// 几何数据
std::shared_ptr<Geometry::GeometryData> m_geometryData;  // 几何数据

// 模型变换
QQuaternion m_modelRotation;               // 模型旋转（四元数，避免万向锁）
QVector3D m_modelCenter;                   // 模型中心点（旋转轴心）
```

**关键方法**：
| 方法 | 功能 |
|------|------|
| `setGeometryData()` | 设置要渲染的几何数据 |
| `rotateModel(yaw, pitch)` | 旋转模型（轨迹球风格） |
| `modelMatrix()` | 获取模型变换矩阵 |
| `init()` | 初始化 OpenGL 资源 |
| `paint()` | 每帧渲染 |

**渲染流程**：
```
paint() 调用流程:
1. 设置视口 (glViewport)
2. 清除背景 (glClear)
3. 绑定着色器 (m_program->bind)
4. 计算变换矩阵:
   - Model = modelMatrix() (包含旋转)
   - View = m_camera->viewMatrix()
   - Projection = m_camera->projectionMatrix()
   - MVP = Projection × View × Model
5. 上传 Uniform 变量
6. 绘制几何体 (glDrawElements)
```

**模型旋转原理**（轨迹球风格）：
```cpp
void rotateModel(float delta_yaw, float delta_pitch) {
    // 使用屏幕空间旋转，无论模型当前朝向如何，鼠标操作都直观
    // delta_yaw: 鼠标水平移动 → 绕屏幕 Y 轴旋转
    // delta_pitch: 鼠标垂直移动 → 绕屏幕 X 轴旋转
    
    QQuaternion yaw_rotation = QQuaternion::fromAxisAndAngle(Y轴, -delta_yaw);
    QQuaternion pitch_rotation = QQuaternion::fromAxisAndAngle(X轴, -delta_pitch);
    
    // 前乘：新旋转在屏幕空间应用
    m_modelRotation = yaw_rotation * pitch_rotation * m_modelRotation;
}
```

---

### 1.2 Camera (`render/camera.hpp/cpp`)

**职责**：相机系统，管理观察位置和投影。

**注意**：Camera 只负责 **视角变换**（View Matrix），模型旋转由 OpenGLRenderer 处理。

**关键成员变量**：
```cpp
QVector3D m_target;      // 相机目标点（看向的位置）
float m_distance;        // 相机距离目标的距离
float m_yaw, m_pitch;    // 相机方位角和俯仰角（仅用于初始视角）
float m_fov;             // 视野角度
float m_nearPlane, m_farPlane;  // 近远裁剪面
```

**关键方法**：
| 方法 | 功能 |
|------|------|
| `viewMatrix()` | 返回视图变换矩阵 |
| `projectionMatrix(aspect)` | 返回投影矩阵 |
| `zoom(factor)` | 缩放（改变距离） |
| `pan(dx, dy)` | 平移（移动目标点） |
| `fitToBounds(min, max)` | 自动适应边界框 |

---

### 1.3 LightingEnvironment (`render/lighting.hpp/cpp`)

**职责**：管理场景光照。

**支持的光源类型**：
```cpp
enum class LightType {
    Directional = 0,  // 平行光（太阳光）
    Point = 1,        // 点光源
    Headlight = 2     // 头灯（跟随相机）
};
```

---

### 1.4 着色器 (GLSL)

**顶点着色器** (GLSL 1.20)：
```glsl
attribute vec3 aPos;      // 顶点位置
attribute vec3 aNormal;   // 法向量
attribute vec3 aColor;    // 顶点颜色

uniform mat4 uMVP;        // MVP 矩阵
uniform mat4 uModel;      // 模型矩阵
uniform mat3 uNormalMatrix; // 法向量矩阵

void main() {
    gl_Position = uMVP * vec4(aPos, 1.0);
    vWorldPos = vec3(uModel * vec4(aPos, 1.0));
    vNormal = normalize(uNormalMatrix * aNormal);
    vColor = aColor;
}
```

**片段着色器**：
- 支持最多 4 个光源
- Phong 光照模型（环境光 + 漫反射 + 镜面反射）
- 支持顶点颜色和颜色覆盖

---

## 二、几何模块

### 2.1 GeometryData (`geometry/geometry.hpp`)

**职责**：存储三角形网格数据。

**数据结构**：
```cpp
class GeometryData {
    // 顶点数据: [x,y,z, nx,ny,nz, r,g,b] × N
    std::vector<float> m_vertices;   // 每顶点 9 个浮点数
    
    // 索引数据
    std::vector<unsigned int> m_indices;
    
    // 边界框
    float m_minPoint[3], m_maxPoint[3];
};
```

**顶点布局**：
| 偏移 | 数据 | 说明 |
|------|------|------|
| 0-2 | x, y, z | 位置 |
| 3-5 | nx, ny, nz | 法向量 |
| 6-8 | r, g, b | 颜色 (0-1) |

---

### 2.2 ShapeTriangulator (`geometry/shape_triangulator.hpp/cpp`)

**职责**：将 OpenCASCADE 的 TopoDS_Shape 转换为三角形网格。

**调用流程**：
```
TopoDS_Shape (OCC几何体)
    ↓
BRepMesh_IncrementalMesh (网格化)
    ↓
遍历所有 Face
    ↓
提取三角形 + 法向量 + 颜色
    ↓
GeometryData
```

---

## 三、IO 模块

### 3.1 IModelReader (`io/model_reader.hpp`)

**职责**：模型文件读取器接口。

```cpp
class IModelReader {
public:
    virtual bool read(const std::string& filepath) = 0;
    virtual TopoDS_Shape shape() const = 0;
    virtual std::string format() const = 0;
};
```

### 3.2 StepReader / BRepReader

**支持格式**：
- STEP (.stp, .step) - 使用 `STEPControl_Reader`
- BREP (.brep, .brp) - 使用 `BRepTools::Read`

---

## 四、UI 模块

### 4.1 Geometry3D (`ui/geometry3d.hpp/cpp`)

**职责**：QML 中的 3D 渲染组件。

**继承关系**：
```
QQuickItem
    └── Geometry3D
```

**关键成员**：
```cpp
Rendering::OpenGLRenderer* m_renderer;  // 渲染器
QPointF m_lastMousePos;                  // 上一次鼠标位置
DragMode m_dragMode;                     // 拖拽模式 (Orbit/Pan/None)
```

**鼠标交互**：
| 操作 | 功能 |
|------|------|
| 左键拖动 | 旋转模型 |
| Shift + 左键 / 中键 | 平移视角 |
| 滚轮 | 缩放 |

**QML 暴露的方法**：
```cpp
Q_INVOKABLE void zoomIn(qreal factor);
Q_INVOKABLE void zoomOut(qreal factor);
Q_INVOKABLE void fitToView();
Q_INVOKABLE void resetView();
Q_INVOKABLE void setViewFront();
Q_INVOKABLE void setViewBack();
// ... 更多视角方法
```

---

### 4.2 ModelImporter (`ui/model_importer.hpp/cpp`)

**职责**：QML 暴露的模型导入接口。

```cpp
class ModelImporter : public QObject {
    Q_OBJECT
public:
    Q_INVOKABLE void importModel(const QUrl& fileUrl);
    void setTargetRenderer(Geometry3D* renderer);
    
signals:
    void modelLoaded(const QString& filename);
    void modelLoadFailed(const QString& error);
};
```

---

### 4.3 GeometryCreator (`ui/geometry_creator.hpp/cpp`)

**职责**：QML 暴露的几何体创建接口。

```cpp
class GeometryCreator : public QObject {
    Q_OBJECT
public:
    Q_INVOKABLE void createBox(double dx, double dy, double dz);
    
signals:
    void geometryCreated(const QString& name);
    void geometryCreationFailed(const QString& error);
};
```

**创建流程**：
```
createBox(dx, dy, dz)
    ↓
BRepPrimAPI_MakeBox (OCC 创建盒体)
    ↓
ShapeTriangulator::triangulate() (三角化)
    ↓
Geometry3D::setCustomGeometry() (设置到渲染器)
    ↓
触发重绘
```

---

## 五、QML 界面模块

### 5.1 文件结构

```
resources/qml/
├── Main.qml                 # 主窗口
├── Theme.qml                # 暗色主题颜色定义（单例）
├── RibbonToolBar.qml        # Ribbon 工具栏
├── RibbonButtonConfig.qml   # 按钮配置
├── RibbonLargeButton.qml    # 大按钮组件
├── RibbonGroup.qml          # 按钮分组
├── RibbonTabContent.qml     # 标签页内容
├── RibbonFileMenu.qml       # 文件菜单
├── FileMenuItem.qml         # 文件菜单项
├── ModelTreeView.qml        # 模型树视图
├── ViewControlToolbar.qml   # 视图控制工具栏
├── ViewControlButton.qml    # 视图控制按钮
├── CreateBoxDialog.qml      # 创建盒体对话框
├── OperationPanel.qml       # 操作面板
├── OperationPanelManager.qml # 操作面板管理器
└── ThemedIcon.qml           # 带颜色覆盖的图标
```

---

### 5.2 Main.qml

**职责**：应用主窗口，组织所有 UI 组件。

**结构**：
```qml
Window {
    // 暗色主题颜色常量
    readonly property color renderBackground: "#2d3238"
    
    RibbonToolBar {                   // 顶部工具栏
        onAddBox: createBoxDialog.open()
        onImportModel: fileDialog.open()
    }
    
    Geometry3D { id: geometryRenderer }  // 3D 渲染区域
    
    ModelTreeView { }                 // 左侧模型树
    
    ViewControlToolbar {              // 右下角视图控制
        targetRenderer: geometryRenderer
    }
}
```

---

### 5.3 Theme.qml (单例)

**职责**：集中管理暗色主题颜色定义。

**注意**：应用使用固定的暗色主题。所有主题颜色都定义为 readonly 属性。

```qml
pragma Singleton
QtObject {
    // 背景颜色
    readonly property color windowBackground: "#1a1d23"
    readonly property color panelBackground: "#252830"
    readonly property color renderBackground: "#2d3238"
    
    // 文字颜色
    readonly property color textPrimary: "#ffffff"
    readonly property color textSecondary: "#e1e1e1"
    
    // 强调色
    readonly property color accentColor: "#0d6efd"
    // ... 更多颜色
}
```

---

### 5.4 RibbonToolBar.qml

**职责**：Office 风格的 Ribbon 工具栏。

**结构**：
```qml
Rectangle {
    // 标签栏
    Rectangle { id: tabBar }
    
    // 内容区域
    Rectangle { id: contentArea
        RibbonTabContent { groups: buttonConfig.geometryTab }
        RibbonTabContent { groups: buttonConfig.meshTab }
        RibbonTabContent { groups: buttonConfig.aiTab }
    }
    
    // 动作分发
    function dispatchAction(actionId) {
        switch (actionId) {
            case "addBox": addBox(); break;
            // ...
        }
    }
}
```

---

### 5.5 RibbonButtonConfig.qml

**职责**：集中管理所有按钮的配置。

**配置格式**：
```qml
readonly property var geometryTab: [
    {
        title: "Create",
        buttons: [
            {
                id: "addBox",           // 唯一标识，对应信号名
                iconSource: "...",      // SVG 图标路径
                text: "Box",            // 显示文字
                tooltip: "Create a box" // 提示
            }
        ]
    }
]
```

**添加新按钮步骤**：
1. 在 `RibbonButtonConfig.qml` 添加按钮配置
2. 在 `RibbonToolBar.qml` 添加对应 signal
3. 在 `RibbonToolBar.qml` 的 `dispatchAction()` 添加 case
4. 在 `Main.qml` 连接 signal 到实际功能

---

### 5.6 ViewControlToolbar.qml

**职责**：视图控制按钮组（缩放、重置、标准视角）。

**按钮**：
| 按钮 | 功能 |
|------|------|
| Zoom In/Out | 缩放视图 |
| Fit View | 适应边界 |
| Reset | 重置视角 |
| Standard Views | Front/Back/Top/Bottom/Left/Right |

---

## 六、数据流图

### 6.1 模型导入流程

```
用户点击 Import
    ↓
Main.qml: fileDialog.open()
    ↓
FileDialog 选择文件
    ↓
ModelImporter.importModel(url)
    ↓
StepReader/BRepReader.read(path)
    ↓
获得 TopoDS_Shape
    ↓
ShapeTriangulator.triangulate(shape)
    ↓
获得 GeometryData
    ↓
Geometry3D.setCustomGeometry(data)
    ↓
OpenGLRenderer.setGeometryData(data)
    ↓
触发 paint() 重绘
```

### 6.2 鼠标旋转流程

```
鼠标拖动
    ↓
Geometry3D.mouseMoveEvent()
    ↓
计算 delta = currentPos - lastPos
    ↓
OpenGLRenderer.rotateModel(delta.x, delta.y)
    ↓
更新 m_modelRotation (四元数)
    ↓
window()->update() 触发重绘
    ↓
paint() 中 modelMatrix() 使用新旋转
```

---

## 七、核心类关系图

```
┌─────────────────────────────────────────────────────────┐
│                      QML Layer                          │
├─────────────────────────────────────────────────────────┤
│  Main.qml ──┬── RibbonToolBar ── RibbonButtonConfig    │
│             ├── Geometry3D ←───── C++ QQuickItem       │
│             ├── ModelTreeView                           │
│             └── Theme.qml (colors)                      │
└──────────────────────┬──────────────────────────────────┘
                       │ Q_INVOKABLE
┌──────────────────────▼──────────────────────────────────┐
│                    C++ UI Layer                         │
├─────────────────────────────────────────────────────────┤
│  ModelImporter ──────┬──────────── GeometryCreator     │
│         │            │                    │             │
│    IModelReader   ShapeTriangulator  BRepPrimAPI       │
│    (StepReader)         │                              │
└─────────────────────────┼───────────────────────────────┘
                          │ GeometryData
┌─────────────────────────▼───────────────────────────────┐
│                   Render Layer                          │
├─────────────────────────────────────────────────────────┤
│  OpenGLRenderer ──┬── Camera                            │
│         │         └── LightingEnvironment               │
│    QOpenGLFunctions                                     │
│    Shader Program                                       │
└─────────────────────────────────────────────────────────┘
```

---

## 八、关键技术点

### 8.1 四元数旋转

使用四元数避免万向锁（Gimbal Lock）问题：

```cpp
// 轨迹球风格旋转
QQuaternion yaw = QQuaternion::fromAxisAndAngle(Y轴, -delta_yaw);
QQuaternion pitch = QQuaternion::fromAxisAndAngle(X轴, -delta_pitch);
m_modelRotation = yaw * pitch * m_modelRotation;  // 前乘 = 屏幕空间
```

### 8.2 Qt Quick 与 OpenGL 集成

```cpp
// 连接到 Qt Quick 渲染管线
connect(window, &QQuickWindow::beforeRendering, 
        renderer, &OpenGLRenderer::init);
connect(window, &QQuickWindow::beforeRenderPassRecording,
        renderer, &OpenGLRenderer::paint);
```

### 8.3 SVG 图标着色

使用 `Qt5Compat.GraphicalEffects` 的 `ColorOverlay`：

```qml
Image { id: icon; visible: false }
ColorOverlay {
    source: icon
    color: "#e1e1e1"  // 暗色主题的图标颜色
}
```

---

## 九、常见开发任务

### 9.1 添加新的几何体创建功能

1. **GeometryCreator** 添加新方法：
```cpp
Q_INVOKABLE void createSphere(double radius);
```

2. **实现**：使用 OCC API 创建形状，三角化，设置到渲染器

3. **QML 连接**：
```qml
onAddSphere: GeometryCreator.createSphere(1.0)
```

### 9.2 添加新的视图功能

在 `Geometry3D` 添加 `Q_INVOKABLE` 方法，然后在 QML 中调用。

### 9.3 修改光照

在 `OpenGLRenderer::init()` 中修改 `m_lighting` 配置。

---

*文档版本: 2.0*
*最后更新: 2025-12-11*
